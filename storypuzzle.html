<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Schoolhood Memories Puzzle Game ‚Äî Images + Congrats Modal</title>
<style>
:root{--kbd:#6c63ff;--danger:#ff6b6b}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:20px;background:#fafafa;color:#111}
header{display:flex;align-items:center;gap:14px}
h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.common-btn{background:var(--kbd);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
.common-btn.secondary{background:#ddd;color:#111}
#chapterHeading{font-weight:700;margin-top:6px}

/* key & grid */
#keyContainer{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:8px 0}
#key{display:flex;flex-wrap:wrap;gap:6px}
.swatch{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer;user-select:none;font-weight:900;color:transparent;border:2px solid rgba(0,0,0,0.25);transition:all 220ms ease}
.swatch.selected{border:3px solid #000 !important;transform:scale(1.08)}
.swatch.revealed{background:#d0d0d0 !important;color:#000 !important;font-weight:900}
#hintBtn{width:auto;padding:6px 10px;border-radius:4px;font-size:14px;background:#ddd;color:#111;border:2px solid rgba(0,0,0,0.35);cursor:pointer}

#grid-wrapper{max-height:calc((100vw/10)*15 + 30px);overflow-y:auto;overflow-x:hidden;margin:0 auto}
#grid{display:grid;grid-template-columns:repeat(10, minmax(0, 1fr));gap:2px;max-width:100%}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:6px;user-select:none;font-size:1rem;background:#ccc;transition:background-color 300ms,color 200ms,transform 150ms}
.cell.hidden{color:transparent}
.cell.char-visible{color:#000}
.flash{animation:flash 360ms}
.hint-flash{animation:hintFlash 600ms}
@keyframes flash{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
@keyframes hintFlash{0%,100%{transform:scale(1);background-color:#fff;color:#000}50%{transform:scale(1.2);background-color:#ff0;color:#000}}

.status{font-size:13px;color:#444;margin-top:6px}

/* chapter images container */
#chapterImageContainer{display:flex;flex-direction:column;gap:8px;margin-top:12px}
#chapterImageContainer img{max-width:100%;border:2px solid #ccc;display:block}

/* congrats modal */
#congratsModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:10000}
#congratsModal .modalCard{background:#fff;padding:18px;border-radius:10px;max-width:520px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,0.25);text-align:center}
#congratsModal h2{margin:0 0 6px 0;font-size:20px}
#congratsModal p{margin:0 0 12px 0;color:#333}
.modalActions{display:flex;gap:10px;justify-content:center;margin-top:10px}

/* responsive */
@media (min-width:600px){
  #grid{max-width:600px}
}
</style>
</head>
<body>
<header>
  <span style="font-size:28px">üß©</span>
  <div><h1>Schoolhood Memories Puzzle Game ‚Äî Images + Congrats Modal</h1></div>
</header>

<div class="controls">
  <button id="saveQuit" class="common-btn">Save &amp; Quit</button>
  <button id="resetProgress" class="common-btn secondary">Change Colours</button>
  <button id="prevChapter" class="common-btn secondary">Previous Chapter</button>
  <button id="nextChapter" class="common-btn secondary">Next Chapter</button>
</div>

<div id="chapterHeading"></div>

<div id="keyContainer">
  <div id="key"></div>
  <button id="hintBtn">üîç</button>
</div>

<div id="grid-wrapper">
  <div id="grid"></div>
</div>

<div class="status" id="foundStatus"></div>

<!-- images will be inserted here -->
<div id="chapterImageContainer" aria-hidden="true"></div>

<!-- congrats modal -->
<div id="congratsModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard" role="document">
    <h2>üéâ Congratulations! üéâ</h2>
    <p>You have earned the right to download this chapter.</p>
    <div class="modalActions">
      <button id="downloadChapterBtn" class="common-btn">Download Chapter</button>
      <button id="continueBtn" class="common-btn secondary">Continue</button>
    </div>
  </div>
</div>

<script>
// --- Chapters (example) ---
let chapters = [
  {
    title: "Chapter 1 - Joey Banks",
    raw: "I was thinking about all the kids I went to school with Where are they Who were they What were they Rich Dead Happy Dead Happy Famous Probably not as there isnt one famous name among all the names I can remember and I can remember everyones names Thats something you dont forget the names of the kids you went to school with After all you heard them every day for years",
    image: "year7.jpg"
  },
  {
    title: "Chapter 2 - First Day Fumbles",
    raw: "My first day at the new school was a disaster I tripped over my own shoelaces spilled my lunch and ended up in the wrong classroom Everyone laughed but I survived somehow",
    images: ["year7.jpg","year7.jpg","year7.jpg"]
  }
];

let currentChapter = 0;
const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split('');
const GRID_SIZE = 13*13;
let chapterGrid = [], revealedLetters = {}, revealedCells = new Set(), selectedLetter = null;
let keyColors = {}, vibrantKeyColors = {}, cycleCounter = 0;

// --- HSL Utilities ---
function hslToHex(h,s,l){
  h/=360; s/=100; l/=100;
  let r,g,b;
  if(s===0){ r=g=b=l; }
  else {
    const hue2rgb = (p,q,t) => {
      if(t<0) t+=1;
      if(t>1) t-=1;
      if(t<1/6) return p+(q-p)*6*t;
      if(t<1/2) return q;
      if(t<2/3) return p+(q-p)*(2/3-t)*6;
      return p;
    };
    const q = l < 0.5 ? l*(1+s) : l+s-l*s;
    const p = 2*l - q;
    r = hue2rgb(p,q,h+1/3);
    g = hue2rgb(p,q,h);
    b = hue2rgb(p,q,h-1/3);
  }
  return "#" + [r,g,b].map(v=>Math.round(v*255).toString(16).padStart(2,"0")).join('');
}

function blendHSL(hsl1,hsl2,t){
  const h = (hsl1.h*(1-t) + hsl2.h*t + 360) % 360;
  const s = Math.min(100, Math.max(0, Math.round(hsl1.s*(1-t) + hsl2.s*t)));
  const l = Math.min(100, Math.max(0, Math.round(hsl1.l*(1-t) + hsl2.l*t)));
  return {h,s,l};
}

function randomSecondaryBase(){
  return {
    h: Math.floor(Math.random()*360),
    s: 40 + Math.random()*30,
    l: 50 + Math.random()*20
  };
}

// --- Generate Vibrant Key ---
function generateKey(){
  let o = {}, oHSL = {};
  ALPHABET.forEach(L=>{
    const h = Math.floor(Math.random()*360);
    const s = 70 + Math.random()*20;
    const l = 40 + Math.random()*20;
    oHSL[L] = {h, s: Math.round(s), l: Math.round(l)};
    o[L] = hslToHex(h,s,l);
  });
  o[" "] = "#fafafa"; oHSL[" "] = {h:0,s:0,l:98};
  return {hex:o, hsl:oHSL};
}

// --- Apply 3 Vibrant + 2 Complementary (tinted to random secondary) ---
function applySecondaryTintComplementaryRandom(vibrantHSL){
  const out = {};
  const secondaryBaseColor = randomSecondaryBase();
  let patternIndex = 0;
  ALPHABET.forEach(letter=>{
    if(letter === " "){ out[letter] = "#fafafa"; return; }
    if(patternIndex < 3){
      out[letter] = hslToHex(vibrantHSL[letter].h, vibrantHSL[letter].s, vibrantHSL[letter].l);
    } else {
      const tintFactor = 0.3 + Math.random()*0.5;
      const blended = blendHSL(vibrantHSL[letter], secondaryBaseColor, tintFactor);
      out[letter] = hslToHex(blended.h, blended.s, blended.l);
    }
    patternIndex = (patternIndex + 1) % 5;
  });
  return out;
}

// --- Grid & Key Population ---
function populateGrid(){
  const text = (chapters[currentChapter] && chapters[currentChapter].raw) || "";
  chapterGrid = Array(GRID_SIZE).fill(" ");
  for(let i=0;i<text.length && i<GRID_SIZE; i++) chapterGrid[i] = text[i];
  if(!revealedLetters[currentChapter]) revealedLetters[currentChapter] = new Set();
  // rebuild revealedCells for already revealed letters
  revealedCells = new Set();
  revealedLetters[currentChapter].forEach(letter=>{
    chapterGrid.forEach((c,i)=>{ if(c.toLowerCase()===letter) revealedCells.add(i); });
  });
}

function buildKey(){
  const key = document.getElementById("key");
  key.innerHTML = "";
  const lettersInChapter = new Set(chapterGrid.filter(c=>/[a-z]/i.test(c)).map(c=>c.toLowerCase()));
  ALPHABET.forEach(letter=>{
    const sw = document.createElement("div");
    sw.className = "swatch";
    sw.dataset.letter = letter;
    sw.style.background = (keyColors[letter] || "#fafafa");
    if(revealedLetters[currentChapter].has(letter) || !lettersInChapter.has(letter)){
      sw.classList.add("revealed");
      sw.textContent = letter.toUpperCase();
      revealedLetters[currentChapter].add(letter);
    }
    sw.addEventListener("click", ()=>{
      if(revealedLetters[currentChapter].has(letter)) return;
      selectedLetter = letter;
      highlightKey(letter);
    });
    key.appendChild(sw);
  });
}

function highlightKey(letter){
  document.querySelectorAll("#key .swatch").forEach(s=>{
    if(s.dataset.letter===letter && !revealedLetters[currentChapter].has(letter)){
      s.classList.add("selected");
    } else s.classList.remove("selected");
  });
}

function buildGrid(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  chapterGrid.forEach((ch,i)=>{
    const cell = document.createElement("div");
    cell.className = "cell";
    const isLetter = /[a-z]/i.test(ch);
    const l = isLetter ? ch.toLowerCase() : " ";
    cell.style.background = keyColors[l] || "#eee";
    if(isLetter && !revealedCells.has(i) && !revealedLetters[currentChapter].has(l)) cell.classList.add("hidden");
    else cell.classList.add("char-visible");
    cell.textContent = isLetter ? (revealedCells.has(i) ? ch : "") : ch;
    cell.addEventListener("click", ()=>{ if(selectedLetter) handleDrop(selectedLetter, i); });
    grid.appendChild(cell);
  });
}

function handleDrop(letter, index){
  const ch = chapterGrid[index];
  if(!/[a-z]/i.test(ch)) return flash(index);
  if(ch.toLowerCase() === letter){
    revealedLetters[currentChapter].add(letter);
    chapterGrid.forEach((c,i)=>{ if(c.toLowerCase()===letter) revealedCells.add(i); });
    buildGrid();
    buildKey();
    updateFound();
    checkCompletion();
  } else flash(index);
}

function flash(i){
  const c = document.getElementById("grid").children[i];
  if(!c) return;
  c.classList.add("flash");
  setTimeout(()=>c.classList.remove("flash"), 360);
}

document.getElementById("hintBtn").addEventListener("click", ()=>{
  if(!selectedLetter) return;
  let flashed = false;
  for(let i=0;i<chapterGrid.length;i++){
    if(chapterGrid[i].toLowerCase()===selectedLetter && !revealedCells.has(i)){
      flashed = true;
      const c = document.getElementById("grid").children[i];
      c.classList.add("hint-flash");
      setTimeout(()=>c.classList.remove("hint-flash"), 600);
    }
  }
  if(!flashed){
    const selected = document.querySelector("#key .swatch.selected");
    if(selected){ selected.classList.add("flash"); setTimeout(()=>selected.classList.remove("flash"), 360); }
  }
});

function updateFound(){
  const lettersInGrid = new Set(chapterGrid.filter(c=>/[a-z]/i.test(c)).map(c=>c.toLowerCase()));
  const revealedCount = [...revealedLetters[currentChapter]].filter(l=>lettersInGrid.has(l)).length;
  document.getElementById("foundStatus").textContent = `Revealed: ${revealedCount} / ${lettersInGrid.size}`;
}

// --- Show chapter image(s) ---
function showChapterImage(){
  const ch = chapters[currentChapter];
  const container = document.getElementById("chapterImageContainer");
  if(!container) return; // should exist in DOM
  container.innerHTML = "";
  if(ch.images && ch.images.length > 0){
    ch.images.forEach(src=>{
      const img = document.createElement("img");
      img.src = src;
      img.alt = "";
      container.appendChild(img);
    });
  } else if(ch.image){
    const img = document.createElement("img");
    img.src = ch.image;
    img.alt = "";
    container.appendChild(img);
  }
}

// --- Completion modal ---
function checkCompletion(){
  const lettersInGrid = new Set(chapterGrid.filter(c=>/[a-z]/i.test(c)).map(c=>c.toLowerCase()));
  const revealedCount = [...revealedLetters[currentChapter]].filter(l=>lettersInGrid.has(l)).length;
  if(lettersInGrid.size > 0 && revealedCount >= lettersInGrid.size){
    showCongratsModal();
  }
}

function showCongratsModal(){
  const modal = document.getElementById("congratsModal");
  modal.style.display = "flex";
  modal.setAttribute("aria-hidden","false");
}
function hideCongratsModal(){
  const modal = document.getElementById("congratsModal");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden","true");
}

// --- Download chapter btn ---
document.getElementById("downloadChapterBtn").addEventListener("click", ()=>{
  const text = chapters[currentChapter] && chapters[currentChapter].raw ? chapters[currentChapter].raw : "";
  const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Chapter_${currentChapter+1}.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// continue button
document.getElementById("continueBtn").addEventListener("click", ()=>{
  hideCongratsModal();
  if(currentChapter < chapters.length - 1){
    currentChapter++;
    revealedCells = new Set();
    selectedLetter = null;
    if(!revealedLetters[currentChapter]) revealedLetters[currentChapter] = new Set();
    populateGrid();
    advanceCycleAndApplyColors({fromChapterLoad:true});
    updateFound();
  }
});

// --- Advance Cycle & Colours ---
function advanceCycleAndApplyColors({fromChapterLoad=false}={}){
  cycleCounter++;
  document.getElementById("chapterHeading").textContent = chapters[currentChapter].title;
  const g = generateKey();
  vibrantKeyColors = g;
  keyColors = applySecondaryTintComplementaryRandom(g.hsl);
  buildKey();
  buildGrid();
  showChapterImage();
}

// --- Buttons ---
document.getElementById("saveQuit").onclick = ()=>{ alert("Progress saved ‚úÖ"); };
document.getElementById("resetProgress").onclick = ()=>{ advanceCycleAndApplyColors(); };
document.getElementById("nextChapter").onclick = ()=>{
  if(currentChapter < chapters.length-1){
    currentChapter++;
    revealedCells = new Set();
    selectedLetter = null;
    if(!revealedLetters[currentChapter]) revealedLetters[currentChapter] = new Set();
    populateGrid(); advanceCycleAndApplyColors({fromChapterLoad:true}); updateFound();
  } else alert("You finished all chapters ‚úÖ");
};
document.getElementById("prevChapter").onclick = ()=>{
  if(currentChapter > 0){
    currentChapter--;
    revealedCells = new Set();
    selectedLetter = null;
    if(!revealedLetters[currentChapter]) revealedLetters[currentChapter] = new Set();
    populateGrid(); advanceCycleAndApplyColors({fromChapterLoad:true}); updateFound();
  }
};

// --- Init ---
document.addEventListener("DOMContentLoaded", ()=>{
  populateGrid();
  advanceCycleAndApplyColors({fromChapterLoad:true});
  updateFound();
});
</script>
</body>
</html>
